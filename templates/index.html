<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Defect Detection System</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
		integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
	<style>
		/* ... keep all your existing styles ... */
		
		/* Add new style for detection info */
		.detection-info {
			background-color: #f8f9fa;
			border: 1px solid #dee2e6;
			border-radius: 5px;
			padding: 15px;
			margin-top: 10px;
			max-height: 300px;
			overflow-y: auto;
		}

		.detection-item {
			padding: 8px;
			margin: 5px 0;
			background: white;
			border-left: 4px solid #007bff;
			border-radius: 3px;
		}

		.defect-badge {
			display: inline-block;
			padding: 3px 8px;
			border-radius: 3px;
			font-size: 12px;
			font-weight: bold;
			margin-right: 5px;
		}

		.defect-crazing { background-color: #ff6b6b; color: white; }
		.defect-inclusion { background-color: #4ecdc4; color: white; }
		.defect-patches { background-color: #45b7d1; color: white; }
		.defect-pitted_surface { background-color: #f9ca24; color: #333; }
		.defect-rolled-in_scale { background-color: #6c5ce7; color: white; }
		.defect-scratches { background-color: #fd79a8; color: white; }
	</style>
</head>

<body>
	<!-- Header -->
	<header class="bg-primary text-center py-5 mb-4">
		<div class="container">
			<h1 class="font-weight-light text-white">Surface Defect Detection System</h1>
			<p class="text-white-50">Detecting: Crazing, Inclusion, Patches, Pitted Surface, Rolled-in Scale, Scratches</p>
		</div>
	</header>
  
	<!-- Page Content -->
	<div class="container">
		<form class="input-group upload-data row">	
			<div class="col-xl-6 col-md-6 col-sm-6 mb-2">
				<button type="button" class="btn btn-primary col-12" id="uload">
					üì§ Upload Image
				</button>
			</div>
			<div class="col-xl-6 col-md-6 col-sm-6 mb-2">
				<button id="send" type="button" class="btn btn-success col-12">
					üîç Detect Defects
				</button>
			</div>

			<!-- Updated URL to match your Flask endpoint -->
			<input type="hidden" class="form-control mr-2" id="url" placeholder="Enter REST Api url..." value="/predict" />
			<input name="upload" type="file" id="fileinput" accept="image/*" style="position:absolute;top:-500px; display: none;" /><br />
		</form>

		<div class="row">
			<!-- Input Image Section -->
			<div class="col-xl-6 col-md-6 col-sm-12 mb-4">
				<div class="card border-0 shadow upload-image">
					<div class="card-header bg-info text-white">
						<h5 class="mb-0">üì∑ Input Image</h5>
					</div>
					<video autoplay id="video" poster="https://img.freepik.com/free-vector/group-young-people-posing-photo_52683-18824.jpg?size=338&ext=jpg"></video>
					<img src="" class="" id="photo">
					<canvas style="display:none;" id="canvas"></canvas>
				</div>
			</div>

			<!-- Results Section -->
			<div class="col-xl-6 col-md-6 col-sm-12 mb-4">
				<div class="card border-0 shadow">
					<div class="card-header bg-success text-white">
						<h5 class="mb-0">‚úÖ Detection Results</h5>
					</div>
					<div class="card-body res-part2">
						<p class="text-muted text-center">Upload an image and click "Detect Defects" to see results</p>
					</div>
				</div>

				<!-- Detection Details -->
				<div class="card border-0 shadow mt-3">
					<div class="card-header bg-warning text-dark">
						<h5 class="mb-0">üìä Detection Details</h5>
					</div>
					<div class="card-body detection-info" id="detection-details">
						<p class="text-muted text-center">No detections yet</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Remove or update the logo -->
	<!-- <img class="logo" src="https://apparel.ineuronvision.com/static/logo.png" /> -->

	<div id="loading">
		<div class="loader"></div>
	</div>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
		integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous">
	</script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
		integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous">
	</script>

	<script>
		var mybtn = document.getElementById('startbtn');
		var myvideo = document.getElementById('video');
		var mycanvas = document.getElementById('canvas');
		var myphoto = document.getElementById('photo');
		var base_data = "";

		function sendRequest(base64Data) {
			var type = "json";
			if (base64Data != "" && base64Data != null) {
				var url = $("#url").val();
				$("#loading").show();
				
				$.ajax({
					url: url,
					type: "post",
					cache: false,
					async: true,
					crossDomain: true,
					headers: {
						'Content-Type': 'application/json',
						'Access-Control-Allow-Origin': '*'
					},
					data: JSON.stringify({
						image: base64Data
					}),
					success: function (res) {
						console.log("Response:", res);
						
						// Clear previous results
						$(".res-part2").html("");
						$("#detection-details").html("");
						
						// Display annotated image
						if (res.image) {
							var imageData = res.image;
							$(".res-part2").append("<img class='resp-img' src='data:image/jpeg;base64," +
								imageData + "' alt='Detected defects' />");
						}
						
						// Display detection details
						if (res.detections && res.detections.length > 0) {
							var detailsHtml = '<div class="mb-2"><strong>Found ' + res.count + ' defect(s):</strong></div>';
							
							res.detections.forEach(function(det, idx) {
								var defectClass = det.class.replace(/_/g, '-');
								var confidence = (det.confidence * 100).toFixed(1);
								
								detailsHtml += '<div class="detection-item">';
								detailsHtml += '<span class="defect-badge defect-' + defectClass + '">' + det.class + '</span>';
								detailsHtml += '<span class="badge badge-secondary">' + confidence + '%</span>';
								detailsHtml += '<div class="small text-muted mt-1">Bbox: [' + 
									det.bbox.map(x => x.toFixed(0)).join(', ') + ']</div>';
								detailsHtml += '</div>';
							});
							
							$("#detection-details").html(detailsHtml);
						} else {
							$("#detection-details").html('<p class="text-success text-center">‚úì No defects detected - Surface looks good!</p>');
						}
						
						$("#loading").hide();
					},
					error: function(xhr, status, error) {
						console.error("Error:", error);
						$("#loading").hide();
						
						$(".res-part2").html('<div class="alert alert-danger">Error: ' + 
							(xhr.responseJSON?.message || 'Failed to process image') + '</div>');
						
						$("#detection-details").html('<p class="text-danger">Detection failed. Please try again.</p>');
					}
				});
			} else {
				alert("Please upload an image first!");
			}
		}

		$(document).ready(function () {
			$("#loading").hide();

			$('#send').click(function (evt) {
				evt.preventDefault();
				sendRequest(base_data);
			});

			$('#uload').click(function (evt) {
				evt.preventDefault();
				$('#fileinput').focus().trigger('click');
			});

			$("#fileinput").change(function () {
				if (this.files && this.files[0]) {
					// Reset results
					$("#detection-details").html('<p class="text-muted text-center">Waiting for detection...</p>');
					$(".res-part2").html('');
					
					var reader = new FileReader();
					reader.onload = function (e) {
						var url = e.target.result;
						var img = new Image();
						img.crossOrigin = 'Anonymous';
						img.onload = function () {
							var canvas = document.createElement('CANVAS');
							var ctx = canvas.getContext('2d');
							canvas.height = this.height;
							canvas.width = this.width;
							ctx.drawImage(this, 0, 0);
							base_data = canvas.toDataURL('image/jpeg', 1.0).replace(
								/^data:image.+;base64,/, '');
							canvas = null;
						};
						img.src = url;
						$('#photo').attr('src', url);
						$('#photo').show();
						$('#video').hide();
					}
					reader.readAsDataURL(this.files[0]);
				}
			});
		});
	</script>
</body>

</html>