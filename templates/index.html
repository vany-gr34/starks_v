<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>EagleScanAI - Live Camera Detection</title>
	<script src="https://cdn.tailwindcss.com"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	
	<script>
		tailwind.config = {
			theme: {
				extend: {
					fontFamily: {
						'inter': ['Inter', 'sans-serif'],
					},
					animation: {
						'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
						'bounce-slow': 'bounce 2s infinite',
						'spin-slow': 'spin 3s linear infinite',
					},
					boxShadow: {
						'glow': '0 0 20px rgba(59, 130, 246, 0.3)',
						'glow-lg': '0 0 40px rgba(59, 130, 246, 0.4)',
					}
				}
			}
		}
	</script>

	<style>
		body {
			font-family: 'Inter', sans-serif;
		}

		.glass-effect {
			backdrop-filter: blur(16px);
			background: rgba(255, 255, 255, 0.95);
		}

		.video-container {
			position: relative;
			background: #000;
			border-radius: 1rem;
			overflow: hidden;
			box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
		}

		.video-feed {
			width: 100%;
			height: auto;
			display: block;
		}

		.scanning-overlay {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			height: 3px;
			background: linear-gradient(90deg, transparent 0%, rgba(59, 130, 246, 0.8) 50%, transparent 100%);
			animation: scan 2s linear infinite;
		}

		@keyframes scan {
			0% { transform: translateY(0); }
			100% { transform: translateY(500px); }
		}

		.detection-badge {
			position: absolute;
			top: 1rem;
			right: 1rem;
			padding: 0.5rem 1rem;
			background: rgba(0, 0, 0, 0.7);
			color: white;
			border-radius: 0.5rem;
			font-weight: 600;
			backdrop-filter: blur(10px);
		}

		.status-indicator {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			display: inline-block;
			margin-right: 0.5rem;
		}

		.status-live {
			background: #10B981;
			box-shadow: 0 0 10px #10B981;
			animation: pulse 2s infinite;
		}

		.status-offline {
			background: #EF4444;
		}

		.defect-item {
			transition: all 0.2s ease;
		}

		.defect-item:hover {
			transform: translateX(4px);
		}

		/* Defect type colors */
		.defect-crazing { background-color: #EF4444; color: white; }
		.defect-inclusion { background-color: #06B6D4; color: white; }
		.defect-patches { background-color: #3B82F6; color: white; }
		.defect-pitted-surface { background-color: #F59E0B; color: white; }
		.defect-rolled-in-scale { background-color: #8B5CF6; color: white; }
		.defect-scratches { background-color: #EC4899; color: white; }

		.detection-item {
			padding: 0.75rem;
			background: #F8FAFC;
			border-radius: 0.5rem;
			margin-bottom: 0.5rem;
			display: flex;
			align-items: center;
			justify-content: space-between;
			transition: all 0.2s ease;
		}

		.detection-item:hover {
			background: #E2E8F0;
			transform: translateX(4px);
		}

		.defect-badge {
			display: inline-block;
			padding: 0.25rem 0.75rem;
			border-radius: 9999px;
			font-size: 0.875rem;
			font-weight: 600;
			margin-right: 0.5rem;
		}

		.confidence-badge {
			background: #E5E7EB;
			color: #374151;
			padding: 0.25rem 0.5rem;
			border-radius: 0.375rem;
			font-size: 0.75rem;
			font-weight: 600;
		}

		.alert-pulse {
			animation: alertPulse 1s ease-in-out infinite;
		}

		@keyframes alertPulse {
			0%, 100% { opacity: 1; }
			50% { opacity: 0.6; }
		}
	</style>
</head>

<body class="bg-slate-50 min-h-screen">
	<!-- Navigation Header -->
	<nav class="bg-white border-b border-slate-200 sticky top-0 z-50 glass-effect">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
			<div class="flex justify-between items-center h-16">
				<div class="flex items-center space-x-3">
					<div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
						<i class="fas fa-video text-white"></i>
					</div>
					<div>
						<h1 class="text-xl font-bold text-slate-900">EagleScanAI Live</h1>
						<p class="text-xs text-slate-500">Real-Time Defect Detection</p>
					</div>
				</div>
				<div class="flex items-center space-x-4">
					<div id="camera-status" class="flex items-center space-x-2">
						<span class="status-indicator status-offline"></span>
						<span class="text-sm text-slate-600">Camera Offline</span>
					</div>
					<button id="toggle-camera" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
						<i class="fas fa-play mr-2"></i>Start Camera
					</button>
				</div>
			</div>
		</div>
	</nav>

	<!-- Main Content -->
	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Header Section -->
		<div class="text-center mb-8">
			<h2 class="text-4xl font-bold text-slate-900 mb-4">
				Live Defect Detection for
				<span class="text-blue-600">Sustainable Manufacturing</span>
			</h2>
			<p class="text-lg text-slate-600 max-w-3xl mx-auto">
				Real-time AI-powered quality control monitoring. Detect defects as they happen with instant alerts.
			</p>
		</div>

		<!-- Main Interface Grid -->
		<div class="grid lg:grid-cols-3 gap-8">
			<!-- Live Camera Feed - Takes up 2 columns -->
			<div class="lg:col-span-2 space-y-6">
				<!-- Camera Feed -->
				<div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
					<div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
						<h3 class="text-lg font-semibold text-slate-900 flex items-center">
							<i class="fas fa-video text-blue-600 mr-3"></i>
							Live Camera Feed
						</h3>
						<div class="flex items-center space-x-3">
							<select id="camera-select" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
								<option value="0">Camera 1</option>
							</select>
							<button id="snapshot-btn" class="px-3 py-1 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
								<i class="fas fa-camera mr-1"></i>Snapshot
							</button>
						</div>
					</div>
					
					<div class="p-6">
						<div class="video-container">
							<!-- Camera Feed Image -->
							<img id="camera-feed" src="" class="video-feed" alt="Camera Feed" style="display: none;">
							
							<!-- Placeholder when camera is off -->
							<div id="camera-placeholder" class="flex items-center justify-center bg-slate-900 text-white" style="min-height: 480px;">
								<div class="text-center">
									<i class="fas fa-video-slash text-6xl mb-4 text-slate-600"></i>
									<h4 class="text-xl font-semibold mb-2">Camera Not Active</h4>
									<p class="text-slate-400">Click "Start Camera" to begin live detection</p>
								</div>
							</div>
							
							<!-- Scanning overlay (shown when active) -->
							<div id="scanning-overlay" class="scanning-overlay" style="display: none;"></div>
							
							<!-- Live detection badge -->
							<div id="detection-badge" class="detection-badge" style="display: none;">
								<i class="fas fa-circle-notch fa-spin mr-2"></i>
								<span id="detection-count">Scanning...</span>
							</div>
						</div>

						<!-- Camera Controls -->
						<div class="mt-4 grid grid-cols-3 gap-3">
							<button id="quality-low" class="py-2 px-4 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors text-sm">
								<i class="fas fa-signal mr-2"></i>Low Quality
							</button>
							<button id="quality-medium" class="py-2 px-4 bg-blue-100 border border-blue-300 rounded-lg text-sm font-medium">
								<i class="fas fa-signal mr-2"></i>Medium Quality
							</button>
							<button id="quality-high" class="py-2 px-4 border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors text-sm">
								<i class="fas fa-signal mr-2"></i>High Quality
							</button>
						</div>
					</div>
				</div>

				<!-- Real-time Statistics -->
				<div class="grid grid-cols-4 gap-4">
					<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
						<div class="text-2xl font-bold text-blue-600" id="frames-processed">0</div>
						<div class="text-xs text-slate-600 mt-1">Frames Processed</div>
					</div>
					<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
						<div class="text-2xl font-bold text-red-600" id="defects-found">0</div>
						<div class="text-xs text-slate-600 mt-1">Defects Found</div>
					</div>
					<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
						<div class="text-2xl font-bold text-green-600" id="fps-counter">0</div>
						<div class="text-xs text-slate-600 mt-1">FPS</div>
					</div>
					<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 text-center">
						<div class="text-2xl font-bold text-purple-600" id="avg-confidence">0%</div>
						<div class="text-xs text-slate-600 mt-1">Avg Confidence</div>
					</div>
				</div>
			</div>

			<!-- Detection Panel - Takes up 1 column -->
			<div class="space-y-6">
				<!-- Current Detections -->
				<div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
					<div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
						<h3 class="text-lg font-semibold text-slate-900 flex items-center">
							<i class="fas fa-exclamation-triangle text-amber-600 mr-3"></i>
							Active Detections
						</h3>
					</div>
					
					<div id="detections-container" class="p-6 max-h-96 overflow-y-auto">
						<div id="no-detections" class="text-center py-8">
							<div class="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
								<i class="fas fa-check-circle text-2xl text-green-600"></i>
							</div>
							<p class="text-slate-600">No defects detected</p>
							<p class="text-sm text-slate-500 mt-1">All clear ✓</p>
						</div>
						
						<div id="active-detections" class="hidden space-y-2">
							<!-- Detection items will be inserted here dynamically -->
						</div>
					</div>
				</div>

				<!-- Alert Settings -->
				<div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
					<div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
						<h3 class="text-lg font-semibold text-slate-900 flex items-center">
							<i class="fas fa-bell text-purple-600 mr-3"></i>
							Alert Settings
						</h3>
					</div>
					
					<div class="p-6 space-y-4">
						<div>
							<label class="flex items-center justify-between">
								<span class="text-sm font-medium text-slate-700">Sound Alerts</span>
								<input type="checkbox" id="sound-alerts" class="w-5 h-5 text-blue-600 rounded">
							</label>
						</div>
						<div>
							<label class="flex items-center justify-between">
								<span class="text-sm font-medium text-slate-700">Auto-Capture Defects</span>
								<input type="checkbox" id="auto-capture" class="w-5 h-5 text-blue-600 rounded" checked>
							</label>
						</div>
						<div>
							<label class="text-sm font-medium text-slate-700 block mb-2">Confidence Threshold</label>
							<input type="range" id="confidence-threshold" min="50" max="95" value="75" class="w-full">
							<div class="flex justify-between text-xs text-slate-500 mt-1">
								<span>50%</span>
								<span id="threshold-value" class="font-semibold text-blue-600">75%</span>
								<span>95%</span>
							</div>
						</div>
						<div>
							<label class="text-sm font-medium text-slate-700 block mb-2">Detection Speed</label>
							<select id="detection-speed" class="w-full px-3 py-2 border border-slate-300 rounded-lg">
								<option value="slow">Slow (Higher Accuracy)</option>
								<option value="medium" selected>Medium (Balanced)</option>
								<option value="fast">Fast (Lower Latency)</option>
							</select>
						</div>
					</div>
				</div>

				<!-- Quick Actions -->
				<div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
					<div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
						<h3 class="text-lg font-semibold text-slate-900 flex items-center">
							<i class="fas fa-bolt text-orange-600 mr-3"></i>
							Quick Actions
						</h3>
					</div>
					
					<div class="p-6 space-y-3">
						<button id="clear-detections" class="w-full py-2 px-4 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors">
							<i class="fas fa-eraser mr-2"></i>Clear Detections
						</button>
						<button id="export-data" class="w-full py-2 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
							<i class="fas fa-download mr-2"></i>Export Session Data
						</button>
						<button id="upload-mode" class="w-full py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
							<i class="fas fa-upload mr-2"></i>Switch to Upload Mode
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Performance Dashboard -->
		<div class="mt-12">
			<h3 class="text-2xl font-bold text-slate-900 mb-6 text-center">Session Performance</h3>
			<div class="grid md:grid-cols-6 gap-4">
				<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center hover:shadow-md transition-shadow">
					<div class="w-12 h-12 mx-auto mb-3 bg-blue-100 rounded-full flex items-center justify-center">
						<i class="fas fa-clock text-blue-600"></i>
					</div>
					<div class="text-2xl font-bold text-blue-600" id="session-time">00:00</div>
					<div class="text-sm text-slate-600 font-medium">Session Time</div>
				</div>
				
				<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center hover:shadow-md transition-shadow">
					<div class="w-12 h-12 mx-auto mb-3 bg-red-100 rounded-full flex items-center justify-center">
						<i class="fas fa-exclamation-triangle text-red-600"></i>
					</div>
					<div class="text-2xl font-bold text-red-600" id="total-defects">0</div>
					<div class="text-sm text-slate-600 font-medium">Total Defects</div>
				</div>
				
				<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center hover:shadow-md transition-shadow">
					<div class="w-12 h-12 mx-auto mb-3 bg-green-100 rounded-full flex items-center justify-center">
						<i class="fas fa-tachometer-alt text-green-600"></i>
					</div>
					<div class="text-2xl font-bold text-green-600">0.8s</div>
					<div class="text-sm text-slate-600 font-medium">Avg Process Time</div>
				</div>
				
				<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center hover:shadow-md transition-shadow">
					<div class="w-12 h-12 mx-auto mb-3 bg-purple-100 rounded-full flex items-center justify-center">
						<i class="fas fa-bullseye text-purple-600"></i>
					</div>
					<div class="text-2xl font-bold text-purple-600">94.7%</div>
					<div class="text-sm text-slate-600 font-medium">Model Accuracy</div>
				</div>
				
				<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center hover:shadow-md transition-shadow">
					<div class="w-12 h-12 mx-auto mb-3 bg-orange-100 rounded-full flex items-center justify-center">
						<i class="fas fa-camera text-orange-600"></i>
					</div>
					<div class="text-2xl font-bold text-orange-600" id="snapshots-taken">0</div>
					<div class="text-sm text-slate-600 font-medium">Snapshots Taken</div>
				</div>
				
				<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 text-center hover:shadow-md transition-shadow">
					<div class="w-12 h-12 mx-auto mb-3 bg-indigo-100 rounded-full flex items-center justify-center">
						<i class="fas fa-shield-alt text-indigo-600"></i>
					</div>
					<div class="text-2xl font-bold text-indigo-600">24/7</div>
					<div class="text-sm text-slate-600 font-medium">Uptime Ready</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer -->
	<footer class="bg-white border-t border-slate-200 mt-16">
		<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
			<div class="text-center">
				<div class="mb-4">
					<div class="inline-flex items-center px-4 py-2 bg-green-100 text-green-800 rounded-full text-sm font-medium mb-2">
						<i class="fas fa-leaf mr-2"></i>
						Tangier Sustainability Challenge 2026
					</div>
				</div>
				<p class="text-slate-600">Powered by YOLO11 AI Technology | Real-Time Quality Control</p>
				<div class="mt-4 text-xs text-slate-500">
					EagleScanAI © 2026 - Live Defect Detection System
				</div>
			</div>
		</div>
	</footer>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

	<script>
		// Global variables
		let cameraActive = false;
		let statsInterval = null;
		let sessionStartTime = null;
		let sessionStats = {
			framesProcessed: 0,
			defectsFound: 0,
			snapshotsTaken: 0,
			fps: 0,
			avgConfidence: 0
		};
		let detectionHistory = [];

		// Update session timer
		function updateSessionTimer() {
			if (!sessionStartTime) return;
			
			const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
			const minutes = Math.floor(elapsed / 60);
			const seconds = elapsed % 60;
			$('#session-time').text(
				`${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`
			);
		}

		// Fetch and update statistics from server
		function fetchStats() {
			if (!cameraActive) return;
			
			$.ajax({
				url: '/stats',
				type: 'GET',
				success: function(response) {
					if (response.status === 'success' && response.stats) {
						const stats = response.stats;
						
						// Update display
						$('#frames-processed').text(stats.total_frames || 0);
						$('#defects-found').text(stats.total_detections || 0);
						$('#total-defects').text(stats.total_detections || 0);
						
						// Calculate FPS (approximate)
						if (stats.session_duration_seconds > 0) {
							const fps = Math.round(stats.total_frames / stats.session_duration_seconds);
							$('#fps-counter').text(fps);
						}
						
						// Update detection badge
						if (stats.total_detections > 0) {
							$('#detection-count').html(`<span class="alert-pulse">${stats.total_detections} Defect(s) Detected</span>`);
						} else {
							$('#detection-count').text('Scanning...');
						}
						
						// Update defect counts
						sessionStats.framesProcessed = stats.total_frames;
						sessionStats.defectsFound = stats.total_detections;
					}
				},
				error: function(xhr, status, error) {
					console.error("Error fetching stats:", error);
				}
			});
		}

		// Update camera status
		function updateCameraStatus(active) {
			cameraActive = active;
			
			if (active) {
				$('#camera-status .status-indicator').removeClass('status-offline').addClass('status-live');
				$('#camera-status span').text('Camera Live');
				$('#toggle-camera').html('<i class="fas fa-stop mr-2"></i>Stop Camera').removeClass('bg-blue-600 hover:bg-blue-700').addClass('bg-red-600 hover:bg-red-700');
				$('#camera-placeholder').hide();
				$('#camera-feed').show();
				$('#scanning-overlay').show();
				$('#detection-badge').show();
				$('#snapshot-btn').prop('disabled', false);
				
				// Start session timer
				if (!sessionStartTime) {
					sessionStartTime = Date.now();
					setInterval(updateSessionTimer, 1000);
				}
				
				// Start stats polling
				if (!statsInterval) {
					statsInterval = setInterval(fetchStats, 1000); // Poll every second
				}
				
				// Set camera feed source
				const timestamp = new Date().getTime();
				const confThreshold = $('#confidence-threshold').val() / 100;
				$('#camera-feed').attr('src', `/live?conf=${confThreshold}&t=${timestamp}`);
				
			} else {
				$('#camera-status .status-indicator').removeClass('status-live').addClass('status-offline');
				$('#camera-status span').text('Camera Offline');
				$('#toggle-camera').html('<i class="fas fa-play mr-2"></i>Start Camera').removeClass('bg-red-600 hover:bg-red-700').addClass('bg-blue-600 hover:bg-blue-700');
				$('#camera-placeholder').show();
				$('#camera-feed').hide().attr('src', '');
				$('#scanning-overlay').hide();
				$('#detection-badge').hide();
				$('#snapshot-btn').prop('disabled', true);
				
				// Stop stats polling
				if (statsInterval) {
					clearInterval(statsInterval);
					statsInterval = null;
				}
			}
		}

		// Start camera via API
		function startCamera() {
			$.ajax({
				url: '/camera/start',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({ camera_id: 0 }),
				success: function(response) {
					console.log("Camera started:", response);
					updateCameraStatus(true);
				},
				error: function(xhr, status, error) {
					console.error("Failed to start camera:", error);
					alert("Failed to start camera: " + (xhr.responseJSON?.message || error));
				}
			});
		}

		// Stop camera via API
		function stopCamera() {
			$.ajax({
				url: '/camera/stop',
				type: 'POST',
				contentType: 'application/json',
				success: function(response) {
					console.log("Camera stopped:", response);
					updateCameraStatus(false);
				},
				error: function(xhr, status, error) {
					console.error("Failed to stop camera:", error);
					alert("Failed to stop camera: " + (xhr.responseJSON?.message || error));
				}
			});
		}

		// Add detection to panel
		function addDetection(defectType, confidence) {
			const detectionId = `detection-${Date.now()}-${Math.random()}`;
			const defectClass = defectType.replace(/ /g, '-').toLowerCase();
			
			$('#no-detections').hide();
			$('#active-detections').show();
			
			const html = `
				<div class="detection-item" id="${detectionId}">
					<div class="flex items-center flex-1">
						<span class="defect-badge defect-${defectClass}">${defectType}</span>
						<span class="confidence-badge">${confidence}%</span>
					</div>
					<button class="text-red-600 hover:text-red-800" onclick="removeDetection('${detectionId}')">
						<i class="fas fa-times"></i>
					</button>
				</div>
			`;
			
			$('#active-detections').prepend(html);
			
			// Update stats
			sessionStats.defectsFound++;
			$('#defects-found').text(sessionStats.defectsFound);
			$('#total-defects').text(sessionStats.defectsFound);
			
			// Update detection badge
			$('#detection-count').html(`<span class="alert-pulse">${sessionStats.defectsFound} Defect(s) Detected</span>`);
			
			// Play sound if enabled
			if ($('#sound-alerts').is(':checked')) {
				playAlertSound();
			}
			
			// Auto-capture if enabled
			if ($('#auto-capture').is(':checked')) {
				takeSnapshot();
			}
			
			// Store in history
			detectionHistory.push({
				timestamp: new Date().toISOString(),
				type: defectType,
				confidence: confidence
			});
		}

		// Remove detection
		function removeDetection(detectionId) {
			$(`#${detectionId}`).fadeOut(200, function() {
				$(this).remove();
				
				if ($('#active-detections .detection-item').length === 0) {
					$('#active-detections').hide();
					$('#no-detections').show();
				}
			});
		}

		// Play alert sound
		function playAlertSound() {
			// Create audio context for beep
			const audioContext = new (window.AudioContext || window.webkitAudioContext)();
			const oscillator = audioContext.createOscillator();
			const gainNode = audioContext.createGain();
			
			oscillator.connect(gainNode);
			gainNode.connect(audioContext.destination);
			
			oscillator.frequency.value = 800;
			oscillator.type = 'sine';
			
			gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
			gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
			
			oscillator.start(audioContext.currentTime);
			oscillator.stop(audioContext.currentTime + 0.2);
		}

		// Take snapshot
		function takeSnapshot() {
			if (!cameraActive) {
				alert('Camera must be active to take snapshots');
				return;
			}
			
			const confThreshold = $('#confidence-threshold').val() / 100;
			
			$.ajax({
				url: '/snapshot',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({ conf: confThreshold }),
				success: function(response) {
					console.log("Snapshot captured:", response);
					sessionStats.snapshotsTaken++;
					$('#snapshots-taken').text(sessionStats.snapshotsTaken);
					
					// Visual feedback
					$('#camera-feed').css('filter', 'brightness(1.5)');
					setTimeout(() => {
						$('#camera-feed').css('filter', 'brightness(1)');
					}, 100);
					
					// Show notification
					if (response.detections && response.detections.length > 0) {
						alert(`Snapshot saved! Found ${response.count} defect(s)`);
					} else {
						alert('Snapshot saved! No defects detected.');
					}
				},
				error: function(xhr, status, error) {
					console.error("Snapshot failed:", error);
					alert("Failed to capture snapshot: " + (xhr.responseJSON?.message || error));
				}
			});
		}

		// Export session data
		function exportSessionData() {
			$.ajax({
				url: '/stats',
				type: 'GET',
				success: function(response) {
					if (response.status === 'success') {
						const data = {
							sessionTime: $('#session-time').text(),
							stats: response.stats,
							exportTime: new Date().toISOString(),
							modelInfo: {
								type: "YOLO11n",
								accuracy: "94.7%"
							}
						};
						
						const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
						const url = URL.createObjectURL(blob);
						const a = document.createElement('a');
						a.href = url;
						a.download = `eaglescan-session-${Date.now()}.json`;
						a.click();
						URL.revokeObjectURL(url);
					}
				},
				error: function(xhr, status, error) {
					console.error("Export failed:", error);
					alert("Failed to export data: " + (xhr.responseJSON?.message || error));
				}
			});
		}

		// Clear detections
		function clearDetections() {
			$.ajax({
				url: '/stats/reset',
				type: 'POST',
				contentType: 'application/json',
				success: function(response) {
					console.log("Stats reset:", response);
					$('#active-detections').empty().hide();
					$('#no-detections').show();
					detectionHistory = [];
					
					// Reset display
					$('#frames-processed').text(0);
					$('#defects-found').text(0);
					$('#total-defects').text(0);
					$('#detection-count').text('Scanning...');
					
					// Reset session stats
					sessionStats.framesProcessed = 0;
					sessionStats.defectsFound = 0;
				},
				error: function(xhr, status, error) {
					console.error("Failed to reset stats:", error);
					alert("Failed to clear detections: " + (xhr.responseJSON?.message || error));
				}
			});
		}

		// Event Handlers
		$(document).ready(function() {
			// Toggle camera
			$('#toggle-camera').click(function() {
				if (cameraActive) {
					stopCamera();
				} else {
					startCamera();
				}
			});

			// Snapshot button
			$('#snapshot-btn').click(function(e) {
				e.preventDefault();
				takeSnapshot();
			});

			// Clear detections
			$('#clear-detections').click(function() {
				if (confirm('Clear all detection statistics?')) {
					clearDetections();
				}
			});

			// Export data
			$('#export-data').click(exportSessionData);

			// Upload mode
			$('#upload-mode').click(function() {
				if (confirm('Switch to upload mode? This will stop the camera.')) {
					if (cameraActive) {
						stopCamera();
					}
					window.location.href = '/upload';
				}
			});

			// Confidence threshold slider
			$('#confidence-threshold').on('input', function() {
				$('#threshold-value').text($(this).val() + '%');
			});

			// Quality buttons
			$('.grid button[id^="quality-"]').click(function() {
				$('.grid button[id^="quality-"]').removeClass('bg-blue-100 border-blue-300 font-medium').addClass('border-slate-300');
				$(this).addClass('bg-blue-100 border-blue-300 font-medium').removeClass('border-slate-300');
			});

			// Check camera status on load
			$.ajax({
				url: '/camera/status',
				type: 'GET',
				success: function(response) {
					if (response.camera_active) {
						updateCameraStatus(true);
					}
				}
			});

			// Check model status
			$.ajax({
				url: '/health',
				type: 'GET',
				success: function(response) {
					console.log("Health check:", response);
					if (!response.model_loaded) {
						alert("Warning: Model not loaded properly!");
					}
				},
				error: function() {
					console.warn("Health check failed");
				}
			});
		});

		// Make functions available globally
		window.removeDetection = removeDetection;
	</script>
</body>

</html>